{% extends "base.html" %}

{% block content %}
<div class="section-box">
  <h5 class="section-title">Automatic Job Matching</h5>
  <div class="alert alert-warning" style="background:#fef2e0; border-color:#f5861a; color:#333;">
    Masukkan uraian pekerjaan, lalu sistem akan mencoba mencari kode AHSP yang sesuai.
  </div>

  <table class="table table-bordered align-middle" id="jobsTable">
    <thead>
      <tr style="background-color:#00365a; color:white;">
        <th>No.</th>
        <th>Uraian Pekerjaan</th>
        <th>Kode</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="jobRows">
      <tr>
        <td>1</td>
        <td><input type="text" class="form-control uraian-input" placeholder="Masukkan uraian pekerjaan"></td>
        <td class="match-code">-</td>
        <td class="status-cell">-</td>
      </tr>
    </tbody>
  </table>

  <button class="btn btn-secondary" id="addRow">+ Tambah Pekerjaan</button>
  <button class="btn btn-primary" id="checkCodes" style="background-color:#00365a;">Cek Kode</button>
</div>

<!-- Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header" style="background-color:#00365a;color:white;">
        <h5 class="modal-title">Review Matching Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Pilih kode yang sesuai atau masukkan manual:</p>
        <form id="reviewForm">
          <div id="suggestions-container"></div>
          <div class="mt-3">
            <label for="manualCode" class="form-label">Kode (manual)</label>
            <input type="text" id="manualCode" class="form-control" placeholder="Contoh: A.4.1.2.23">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="saveReview">Simpan</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  let currentRow = null;
  const reviewModal = new bootstrap.Modal(document.getElementById('reviewModal'));

  // Add row
  document.getElementById("addRow").addEventListener("click", () => {
    const tableBody = document.getElementById("jobRows");
    const rowCount = tableBody.rows.length + 1;
    const row = tableBody.insertRow();

    row.innerHTML = `
      <td>${rowCount}</td>
      <td><input type="text" class="form-control uraian-input" placeholder="Masukkan uraian pekerjaan"></td>
      <td class="match-code">-</td>
      <td class="status-cell">-</td>
    `;
  });

  // Match
  document.getElementById("checkCodes").addEventListener("click", async () => {
    const rows = document.querySelectorAll("#jobRows tr");
    for (const row of rows) {
      const uraian = row.querySelector(".uraian-input").value.trim();
      const codeCell = row.querySelector(".match-code");
      const statusCell = row.querySelector(".status-cell");

      if (!uraian) {
        statusCell.innerHTML = `<button class="btn btn-sm btn-secondary" disabled>Not Found</button>`;
        continue;
      }

      // Show spinner
      statusCell.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="spinner-border spinner-border-sm text-primary me-2"></div>
          Matching...
        </div>
      `;

      try {
        const response = await fetch("{% url 'match-best' %}", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({description: uraian})
        });
        const data = await response.json();

        if (data.status === "found" && data.match) {
          codeCell.textContent = data.match.code;
          statusCell.innerHTML = `<button class="btn btn-sm btn-success" disabled>Matched</button>`;
        } else if (data.status.startsWith("found") || data.status === "similar") {
          codeCell.textContent = "-";
          statusCell.innerHTML = `<button class="btn btn-sm btn-warning">Butuh Review</button>`;
          statusCell.querySelector("button").onclick = () => openReviewModal(data.match, row);
        } else {
          codeCell.textContent = "-";
          statusCell.innerHTML = `<button class="btn btn-sm btn-secondary">Tidak Ditemukan</button>`;
          statusCell.querySelector("button").onclick = () => openReviewModal([], row);
        }
      } catch (err) {
        console.error("Error:", err);
        codeCell.textContent = "-";
        statusCell.innerHTML = `<button class="btn btn-sm btn-secondary">Tidak Ditemukan</button>`;
      }
    }
  });

  // Open modal
  function openReviewModal(matches, row) {
    currentRow = row;
    const container = document.getElementById("suggestions-container");
    container.innerHTML = "";

    // Normalize to array
    const matchList = Array.isArray(matches) ? matches : (matches ? [matches] : []);

    if (matchList.length > 0) {
      matchList.forEach((m, idx) => {
        container.innerHTML += `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="matchChoice" id="match${idx}" value="${m.code}">
            <label class="form-check-label" for="match${idx}">
              <strong>${m.code}</strong> â€” ${m.name || "Tanpa nama"} (${Math.round((m.confidence || 0) * 100)}%)
            </label>
          </div>
        `;
      });
    } else {
      container.innerHTML = `<p class="text-muted">No matches found. Please enter manually below.</p>`;
    }

    document.getElementById("manualCode").value = "";
    reviewModal.show();
  }


  // Save review
  document.getElementById("saveReview").addEventListener("click", () => {
    if (!currentRow) return;
    const choice = document.querySelector("input[name='matchChoice']:checked");
    const manualCode = document.getElementById("manualCode").value.trim();

    let finalCode = null;
    if (choice) {
      finalCode = choice.value;
    } else if (manualCode) {
      finalCode = manualCode;
    }

    if (finalCode) {
      currentRow.querySelector(".match-code").textContent = finalCode;
      currentRow.querySelector(".status-cell").innerHTML = `<button class="btn btn-sm btn-success" disabled>Matched (manual)</button>`;
      currentRow = null;
      reviewModal.hide();
    }
  });
</script>
{% endblock %}
