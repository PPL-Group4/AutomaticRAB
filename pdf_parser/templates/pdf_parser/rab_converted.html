{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="section-box position-relative">
  <h5 class="section-title">RAB Preview (PDF)</h5>

  <form id="uploadForm" enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input type="file" name="pdf_file" id="fileInput" accept=".pdf" class="form-control">
      <button type="submit" class="btn btn-primary" style="background-color:#00365a;">Upload & Preview PDF</button>
    </div>
  </form>

  <div id="errorContainer"></div>

  <div id="loadingSpinner" class="text-center py-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Memproses file, mohon tunggu...</p>
  </div>

  <div id="rabTables" class="mt-3"></div>

  <div class="grand-total-box card mt-4 p-3 shadow-sm" id="grandTotalBox" style="display:none; max-width:400px;">
    <div class="d-flex justify-content-between"><span class="fw-bold">Total</span> <span id="grandTotal">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">PPN (10%)</span> <span id="ppn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Total (Termasuk PPN)</span> <span id="totalWithPpn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Terbilang</span> <span id="terbilang">NOL RUPIAH</span></div>
  </div>

  <a href="#" class="btn btn-outline-primary mt-3">+ Tambah Kategori Pekerjaan / Pilih Referensi RAB</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
  {{ block.super }}

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }
  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      alert("Silakan pilih file PDF terlebih dahulu");
      return;
    }
    const formData = new FormData();
    formData.append("pdf_file", fileInput.files[0]);

    try {
      showLoading();
      const resp = await fetch("/pdf_parser/rab_converted/", { method: "POST", body: formData });
      const data = await resp.json();
      hideLoading();

      if (data.rows) renderTable(data.rows);
      else alert("Gagal memproses file: " + (data.error || "Terjadi kesalahan tidak diketahui"));
    } catch (err) {
      hideLoading();
      alert("Error: " + err.message);
    }
  });

  // ---------- Render Editable Table ----------
  function renderTable(rows) {
    const container = document.getElementById("rabTables");
    container.innerHTML = "";
    let total = 0;

    const table = document.createElement("table");
    table.classList.add("table", "table-bordered", "table-sm", "align-middle", "mb-4");
    table.innerHTML = `
      <thead class="table-light">
        <tr>
          <th>No.</th>
          <th>Uraian Pekerjaan</th>
          <th>Kode</th>
          <th>Volume</th>
          <th>SAT</th>
          <th>Harga Sat (Rp.)</th>
          <th>Jumlah (Rp.)</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");

    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.number || ""}</td>
        <td>${row.description || ""}</td>
        <td>${row.analysis_code || ""}</td>
        <td><input type="number" class="form-control form-control-sm volume-input" value="${row.volume || 0}" min="0" step="0.01"></td>
        <td>${row.unit || ""}</td>
        <td><input type="number" class="form-control form-control-sm price-input" value="${row.price || 0}" min="0" step="0.01"></td>
        <td class="total-cell">Rp. ${(row.total_price || 0).toLocaleString("id-ID", { minimumFractionDigits: 2 })}</td>
      `;
      tbody.appendChild(tr);
      total += row.total_price || 0;
    });

    container.appendChild(table);
    updateGrandTotalFromRows();
  }

  // ---------- Listen for Input Changes ----------
  document.addEventListener("input", async (event) => {
    if (!event.target.classList.contains("volume-input") && !event.target.classList.contains("price-input")) return;

    const row = event.target.closest("tr");
    const volume = parseFloat(row.querySelector(".volume-input").value) || 0;
    const price = parseFloat(row.querySelector(".price-input").value) || 0;

    // Instant UI update
    const total = volume * price;
    row.querySelector(".total-cell").textContent =
      "Rp. " + total.toLocaleString("id-ID", { minimumFractionDigits: 2 });

    updateGrandTotalFromRows();

    // Backend recomputation (precise rounding)
    try {
      const response = await fetch("/api/recompute_total_cost/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ volume, unit_price: price }),
      });
      const data = await response.json();
      if (response.ok && data.total_cost) {
        const precise = parseFloat(data.total_cost);
        row.querySelector(".total-cell").textContent =
          "Rp. " + precise.toLocaleString("id-ID", { minimumFractionDigits: 2 });
        updateGrandTotalFromRows();
      }
    } catch (err) {
      console.warn("Fetch error:", err);
    }
  });

  // ---------- Grand Total ----------
  function updateGrandTotalFromRows() {
    let grand = 0;
    document.querySelectorAll(".total-cell").forEach(cell => {
      let text = cell.textContent.replace(/[^\d,.-]/g, "").replace(/\./g, "").replace(",", ".");
      const val = parseFloat(text) || 0;
      grand += val;
    });
    updateGrandTotal(grand);
  }

  function updateGrandTotal(total) {
    document.getElementById("grandTotalBox").style.display = "block";
    document.getElementById("grandTotal").innerText = "Rp. " + total.toLocaleString();
    const ppn = total * 0.1;
    document.getElementById("ppn").innerText = "Rp. " + ppn.toLocaleString();
    document.getElementById("totalWithPpn").innerText = "Rp. " + (total + ppn).toLocaleString();
    document.getElementById("terbilang").innerText =
      total === 0 ? "NOL RUPIAH" : numberToWords(total + ppn).toUpperCase();
  }

  function numberToWords(number) {
    return number.toLocaleString("id-ID") + " rupiah";
  }
</script>
{% endblock %}
