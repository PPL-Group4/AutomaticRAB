{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="section-box position-relative">
  <h5 class="section-title">RAB Preview (PDF)</h5>

  <form id="uploadForm" enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input type="file" name="pdf_file" id="fileInput" accept=".pdf" class="form-control">
      <button type="submit" class="btn btn-primary" style="background-color:#00365a;">Upload & Preview PDF</button>
    </div>
  </form>

  <div id="errorContainer"></div>
  <div id="loadingSpinner" class="text-center py-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Memproses file, mohon tunggu...</p>
  </div>

  <div id="rabTables" class="mt-3"></div>

  <div class="grand-total-box card mt-4 p-3 shadow-sm" id="grandTotalBox" style="display:none; max-width:400px;">
    <div class="d-flex justify-content-between"><span class="fw-bold">Total</span> <span id="grandTotal">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">PPN (10%)</span> <span id="ppn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Total (Termasuk PPN)</span> <span id="totalWithPpn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Terbilang</span> <span id="terbilang">NOL RUPIAH</span></div>
  </div>

  <a href="#" class="btn btn-outline-primary mt-3">+ Tambah Kategori Pekerjaan / Pilih Referensi RAB</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  {{ block.super }}

  const MATCH_ENDPOINT = "{% url 'match-best' %}";
  const suggestionCache = new Map();
  const dropdownRequestState = new WeakMap();
  const MANUAL_SUGGESTION_LIMIT = 12;

  function showError(message) {
    const container = document.getElementById("errorContainer");
    container.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    setTimeout(() => (container.innerHTML = ""), 4000);
  }

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }
  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  // ---------- UPLOAD HANDLER ----------
  document.getElementById("uploadForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      showError("Silakan pilih file PDF terlebih dahulu");
      return;
    }

    const formData = new FormData();
    formData.append("pdf_file", fileInput.files[0]);

    try {
      showLoading();
      const resp = await fetch("/pdf_parser/rab_converted/", { method: "POST", body: formData });
      const data = await resp.json();
      hideLoading();

      if (data.rows) renderTables(data.rows);
      else showError("Gagal memproses file: " + (data.error || "Terjadi kesalahan yang tidak diketahui"));
    } catch (err) {
      hideLoading();
      showError("Terjadi kesalahan saat mengunggah file: " + err.message);
    }
  });

  // ---------- TABLE RENDER ----------
  function renderTables(rows) {
    const container = document.getElementById("rabTables");
    container.innerHTML = "";
    let total = 0;

    const table = document.createElement("table");
    table.classList.add("table", "table-bordered", "table-sm", "align-middle", "mb-4");
    table.innerHTML = `
      <thead class="table-light">
        <tr>
          <th>No.</th>
          <th>Uraian Pekerjaan</th>
          <th>Kode</th>
          <th>Status Pencocokan</th>
          <th>Hasil AHSP</th>
          <th>Volume</th>
          <th>SAT</th>
          <th>Harga Sat (Rp.)</th>
          <th>Jumlah (Rp.)</th>
        </tr>
      </thead>
    `;
    const tbody = document.createElement("tbody");
    table.appendChild(tbody);
    container.appendChild(table);

    rows.forEach((row, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td>${row.description || ""}</td>
        <td class="analysis-code-cell">${row.analysis_code || ""}</td>
        <td>${formatMatchStatusText(row)}</td>
        <td class="match-cell"></td>
        <td><input type="number" class="form-control form-control-sm volume-input" value="${row.volume || 0}" min="0" step="0.01"></td>
        <td>${row.unit || ""}</td>
        <td><input type="number" class="form-control form-control-sm price-input" value="${row.price || 0}" min="0" step="0.01"></td>
        <td class="total-cell">Rp. ${formatCurrencyValue(row.total_price)}</td>
      `;
      tbody.appendChild(tr);

      const matchCell = tr.querySelector(".match-cell");
      const analysisCell = tr.querySelector(".analysis-code-cell");
      const statusCell = tr.children[3];
      populateMatchCell(matchCell, row, analysisCell, statusCell);

      total += parseCurrencyNumber(row.total_price);
    });

    updateGrandTotal(total);
  }

  // ---------- MATCHING LOGIC ----------
  function formatMatchStatusText(row) {
    if (row.job_match_selected) {
      if (row.job_match_selected.match_status === "Manual" || row.job_match_status === "manual") return "Manual";
      return "Dipilih";
    }
    if (!row.job_match_status || row.job_match_status === "skipped") return "Skipped";
    if (row.job_match_status === "error") return "Error";
    const matches = normalizeMatches(row.job_match);
    const fallback = matches.find(entry => entry && entry.match_status && !entry.code);
    return fallback ? fallback.match_status : row.job_match_status.replace(/(^|\s)\w/g, c => c.toUpperCase());
  }

  function populateMatchCell(cell, row, analysisCell, statusCell) {
    if (row.job_match_status === "error") {
      cell.textContent = row.job_match_error || "Error";
      return;
    }

    const matches = normalizeMatches(row.job_match);
    updateRowLookup(row, matches);
    const selectable = matches.filter(m => m && m.code);
    const fallback = matches.filter(m => !m || !m.code);
    
    if (row.job_match_status === "found" && selectable.length === 1) {
      const match = selectable[0];
      row.job_match_selected = match;
      row.analysis_code = match.code;
      analysisCell.textContent = match.code;
      statusCell.textContent = "Dipilih";
      statusCell.classList.add("text-success");

      const span = document.createElement("span");
      span.className = "text-success fw-semibold";
      span.textContent = buildMatchLabel(match);
      cell.appendChild(span);
      return;
    }

    if (!selectable.length && !fallback.length) {
      renderManualInput(cell, row, analysisCell, statusCell, "Needs Manual Input");
      return;
    }

    if (selectable.length) {
      selectable.forEach(match => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "btn btn-sm btn-outline-primary w-100 text-start match-option mb-1";
        const label = buildMatchLabel(match);
        btn.dataset.label = label;
        btn.textContent = label;
        btn.onclick = () => handleMatchSelection(match, row, analysisCell, statusCell, cell, btn);
        cell.appendChild(btn);
      });
    }

    if (fallback.length) renderManualInput(cell, row, analysisCell, statusCell, "Needs Manual Input");
  }

  function buildMatchLabel(match) {
    const parts = [];
    if (match.code) parts.push(match.code);
    if (match.name) parts.push(match.name);
    if (typeof match.confidence === "number") parts.push(Math.round(match.confidence * 100) + "%");
    return parts.join(" â€” ");
  }

  function handleMatchSelection(match, row, analysisCell, statusCell, cell, btn) {
    row.job_match_selected = match;
    row.analysis_code = match.code;
    updateRowLookup(row, [match]);
    analysisCell.textContent = match.code;
    statusCell.textContent = "Dipilih";
    statusCell.classList.add("text-success");

    cell.querySelectorAll("button.match-option").forEach(b => {
      b.classList.remove("btn-success");
      b.classList.add("btn-outline-primary");
      b.textContent = b.dataset.label;
    });
    btn.classList.remove("btn-outline-primary");
    btn.classList.add("btn-success");
    btn.textContent = "Dipilih: " + btn.dataset.label;
  }

  // ---------- MANUAL INPUT ----------
  function renderManualInput(cell, row, analysisCell, statusCell, label) {
    const notice = document.createElement("div");
    notice.className = "text-warning small mb-2";
    notice.textContent = label;
    cell.appendChild(notice);

    const group = document.createElement("div");
    group.className = "input-group input-group-sm";

    const input = document.createElement("input");
    input.type = "text";
    input.className = "form-control";
    input.placeholder = "Masukkan kode AHSP";
    input.value = row.analysis_code || "";

    const button = document.createElement("button");
    button.type = "button";
    button.className = "btn btn-primary";
    button.textContent = "Gunakan";
    button.onclick = () => {
      const val = input.value.trim();
      if (!val) return input.focus();
      row.analysis_code = val;
      row.job_match_selected = { code: val, match_status: "Manual" };
      row.job_match_status = "manual";
      analysisCell.textContent = val;
      statusCell.textContent = "Manual";
      statusCell.classList.add("text-success");
      button.classList.remove("btn-primary");
      button.classList.add("btn-success");
      button.textContent = "Dipakai";
    };

    group.appendChild(input);
    group.appendChild(button);
    cell.appendChild(group);
  }

  // ---------- HELPER FUNCTIONS ----------
  function normalizeMatches(m) { return Array.isArray(m) ? m : (m ? [m] : []); }
  function updateRowLookup(row, matches) {
    row._matchLookup = row._matchLookup || new Map();
    matches.forEach(m => m && m.code && row._matchLookup.set(m.code.toLowerCase(), m));
  }
  function parseCurrencyNumber(v) {
    if (typeof v === "number") return v;
    const n = parseFloat(String(v).replace(/[^0-9.-]/g, ""));
    return Number.isFinite(n) ? n : 0;
  }
  function formatCurrencyValue(v) {
    return parseCurrencyNumber(v).toLocaleString("id-ID", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // ---------- PRICE & TOTAL UPDATE ----------
  document.addEventListener("input", async (event) => {
    if (!event.target.classList.contains("volume-input") && !event.target.classList.contains("price-input")) return;

    const row = event.target.closest("tr");
    const volume = parseFloat(row.querySelector(".volume-input").value) || 0;
    const price = parseFloat(row.querySelector(".price-input").value) || 0;

    // Instant UI update
    const total = volume * price;
    row.querySelector(".total-cell").textContent =
      "Rp. " + total.toLocaleString("id-ID", { minimumFractionDigits: 2 });

    updateGrandTotalFromRows();

    // Backend recomputation
    try {
      const response = await fetch("/api/recompute_total_cost/", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ volume, unit_price: price }),
      });
      const data = await response.json();
      if (response.ok && data.total_cost) {
        const precise = parseFloat(data.total_cost);
        row.querySelector(".total-cell").textContent =
          "Rp. " + precise.toLocaleString("id-ID", { minimumFractionDigits: 2 });
        updateGrandTotalFromRows();
      }
    } catch (err) {
      console.warn("Recompute error:", err);
    }
  });

  function updateGrandTotalFromRows() {
    let grand = 0;
    document.querySelectorAll(".total-cell").forEach((cell) => {
      const val = parseFloat(cell.textContent.replace(/[^\d,.-]/g, "").replace(/\./g, "").replace(",", ".")) || 0;
      grand += val;
    });
    updateGrandTotal(grand);
  }

  function updateGrandTotal(total) {
    document.getElementById("grandTotalBox").style.display = "block";
    document.getElementById("grandTotal").innerText = "Rp. " + total.toLocaleString();
    const ppn = total * 0.1;
    document.getElementById("ppn").innerText = "Rp. " + ppn.toLocaleString();
    document.getElementById("totalWithPpn").innerText = "Rp. " + (total + ppn).toLocaleString();
    document.getElementById("terbilang").innerText =
      total === 0 ? "NOL RUPIAH" : numberToWords(total + ppn).toUpperCase();
  }

  function numberToWords(number) {
    return number.toLocaleString("id-ID") + " rupiah";
  }
</script>
{% endblock %}
