{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="section-box position-relative">
  <h5 class="section-title">RAB Preview (PDF)</h5>

  <!-- Upload form -->
  <form id="uploadForm" enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input type="file" name="pdf_file" id="fileInput" accept=".pdf" class="form-control">
      <button type="submit" class="btn btn-primary" style="background-color:#00365a;">Upload & Preview PDF</button>
    </div>
  </form>

  <div id="rabTables" class="mt-3"></div>

  <!-- Grand total -->
  <div class="grand-total-box card mt-4 p-3 shadow-sm" id="grandTotalBox" style="display:none; max-width:400px;">
    <div class="d-flex justify-content-between"><span class="fw-bold">Total</span> <span id="grandTotal">Rp. 0</span></div>
  </div>

  <!-- Local loading spinner -->
  <div id="loadingSpinner" class="text-center py-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Memproses file, mohon tunggu...</p>
  </div>

  <a href="#" class="btn btn-outline-primary mt-3">+ Tambah Kategori Pekerjaan / Pilih Referensi RAB</a>
</div>
{% endblock %}

{% block extra_js %}
<script>
  {{ block.super }}

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      alert("Pilih file PDF dulu");
      return;
    }
    const formData = new FormData();
    formData.append("pdf_file", fileInput.files[0]);

    try {
      showLoading(); // show spinner inside block
      const resp = await fetch("/pdf_parser/rab_converted/", {
        method: "POST",
        body: formData
      });
      const data = await resp.json();
      hideLoading(); // hide spinner when done

      if (data.rows) {
        renderTable(data.rows);
      } else {
        alert("Gagal parsing file: " + (data.error || "Unknown error"));
      }
    } catch (err) {
      hideLoading();
      alert("Error: " + err.message);
    }
  });

  function renderTable(rows) {
    const container = document.getElementById("rabTables");
    container.innerHTML = "";
    let total = 0;

    const table = document.createElement("table");
    table.classList.add("table","table-bordered","table-sm","align-middle","mb-4");
    table.innerHTML = `
      <thead class="table-light">
        <tr>
          <th>No.</th>
          <th>Uraian Pekerjaan</th>
          <th>Kode</th>
          <th>Volume</th>
          <th>SAT</th>
          <th>Harga Sat (Rp.)</th>
          <th>Jumlah (Rp.)</th>
        </tr>
      </thead>
      <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");

    rows.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.number || ""}</td>
        <td>${row.description || ""}</td>
        <td>${row.analysis_code || ""}</td>
        <td>${(row.volume ?? 0).toLocaleString()}</td>
        <td>${row.unit || ""}</td>
        <td>${(row.price ?? 0).toLocaleString()}</td>
        <td class="jumlah">Rp. ${(row.total_price ?? 0).toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
      total += row.total_price || 0;
    });

    container.appendChild(table);
    document.getElementById("grandTotalBox").style.display = "inline-block";
    document.getElementById("grandTotal").innerText = "Rp. " + total.toLocaleString();
  }
</script>
{% endblock %}
