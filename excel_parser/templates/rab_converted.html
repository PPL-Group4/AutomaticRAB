{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="section-box position-relative">
  <h5 class="section-title">RAB Preview (Excel)</h5>

  <!-- Upload form -->
  <form id="uploadForm" enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input type="file" name="file" id="fileInput" accept=".xls,.xlsx" class="form-control">
      <button type="submit" class="btn btn-primary" style="background-color:#00365a;">Upload & Preview</button>
    </div>
  </form>

  <!-- Error messages -->
  <div id="errorContainer"></div>

  <!-- Spinner -->
  <div id="loadingSpinner" class="text-center py-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Memproses file, mohon tunggu...</p>
  </div>

  <!-- Tables will render here -->
  <div id="rabTables" class="mt-3"></div>

  <!-- Grand total -->
  <div class="grand-total-box card mt-4 p-3 shadow-sm" id="grandTotalBox" style="display:none; max-width:400px;">
    <div class="d-flex justify-content-between"><span class="fw-bold">Total</span> <span id="grandTotal">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">PPN (10%)</span> <span id="ppn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Total (Termasuk PPN)</span> <span id="totalWithPpn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Terbilang</span> <span id="terbilang">NOL RUPIAH</span></div>
  </div>

  <a href="#" class="btn btn-outline-primary mt-3">+ Tambah Kategori Pekerjaan / Pilih Referensi RAB</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  {{ block.super }}

  function showError(message) {
    const errorContainer = document.getElementById("errorContainer");
    errorContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    setTimeout(() => {
      errorContainer.innerHTML = "";
    }, 5000);
  }

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      showError("Silakan pilih file Excel terlebih dahulu");
      return;
    }
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
      showLoading(); // spinner ON
      const resp = await fetch("/excel_parser/preview_rows", {
        method: "POST",
        body: formData
      });
      const data = await resp.json();
      hideLoading(); // spinner OFF

      if (data.rows) {
        renderTables(data.rows);
      } else {
        showError("Gagal memproses file: " + (data.error || "Terjadi kesalahan yang tidak diketahui"));
      }
    } catch (err) {
      hideLoading();
      showError("Terjadi kesalahan saat mengunggah file: " + err.message);
    }
  });

  function renderTables(rows) {
    const container = document.getElementById("rabTables");
    container.innerHTML = "";
    let total = 0;
    let currentTable = null;
    let tbody = null;
    let bujakCounter = 0;

    rows.forEach(row => {
      // Skip calculation rows
      const skipKeywords = ["PAJAK", "JUMLAH SETELAH PAJAK", "DIBULATKAN", "TERBILANG"];
      if (row.description && skipKeywords.some(k => row.description.toUpperCase().includes(k))) return;

      // BUJAK header
      if (row.is_section && row.section_type === "CATEGORY" && row.number === "A") {
        bujakCounter++;
        const header = document.createElement("div");
        header.classList.add("alert","alert-warning","fw-bold","mt-3");
        header.innerText = `BUJAK ${bujakCounter}`;
        container.appendChild(header);

        // New table for BUJAK
        const table = document.createElement("table");
        table.classList.add("table","table-bordered","table-sm","align-middle","mb-4");
        table.innerHTML = `
          <thead class="table-light">
            <tr>
              <th>No.</th>
              <th>Uraian Pekerjaan</th>
              <th>Kode</th>
              <th>Volume</th>
              <th>SAT</th>
              <th>Harga Sat (Rp.)</th>
              <th>Jumlah (Rp.)</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;
        container.appendChild(table);
        currentTable = table;
        tbody = table.querySelector("tbody");
      }

      if (row.is_section && row.section_type === "CATEGORY") {
        if (!currentTable) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.number}</td><td colspan="6"><strong>${row.description}</strong></td>`;
        tbody.appendChild(tr);
      }
      else if (row.is_section && row.section_type === "SECTION") {
        if (!currentTable) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${row.number}</td><td colspan="6"><em>${row.description}</em></td>`;
        tbody.appendChild(tr);
      }
      else if (!row.is_section) {
        if (!currentTable) return;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td></td>
          <td>${row.description || ""}</td>
          <td>${row.analysis_code || ""}</td>
          <td>${row.volume || ""}</td>
          <td>${row.unit || ""}</td>
          <td>${(row.price || 0).toLocaleString()}</td>
          <td>Rp. ${(row.total_price || 0).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
        total += row.total_price || 0;
      }
    });

    // Update grand total
    document.getElementById("grandTotalBox").style.display = "block";
    document.getElementById("grandTotal").innerText = "Rp. " + total.toLocaleString();
    const ppn = total * 0.1;
    document.getElementById("ppn").innerText = "Rp. " + ppn.toLocaleString();
    document.getElementById("totalWithPpn").innerText = "Rp. " + (total + ppn).toLocaleString();
    document.getElementById("terbilang").innerText = total === 0 ? "NOL RUPIAH" : numberToWords(total + ppn).toUpperCase();
  }

  function numberToWords(number) {
    return number.toLocaleString("id-ID") + " rupiah";
  }
</script>
{% endblock %}
