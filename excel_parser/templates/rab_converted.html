{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <title>RAB Editor</title>

<link rel="stylesheet" href="{% static 'excel_parser/style.css' %}">

  <style>
    .bujak-header {
      margin-top: 20px;
      margin-bottom: 10px;
      padding: 6px 12px;
      background-color: #ffedd5;
      border-left: 6px solid #f97316;
      font-weight: bold;
      font-size: 16px;
    }
    .rab-category {
      margin-bottom: 25px;
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    .rab-category th, .rab-category td {
      border: 1px solid #ddd;
      padding: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .rab-category td:hover {
      overflow: visible;
      white-space: normal;
      word-wrap: break-word;
    }
    .rab-category th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    /* Column widths */
    .rab-category th:nth-child(1),
    .rab-category td:nth-child(1) {
      width: 5%;
    }
    .rab-category th:nth-child(2),
    .rab-category td:nth-child(2) {
      width: 35%;
    }
    .rab-category th:nth-child(3),
    .rab-category td:nth-child(3) {
      width: 10%;
    }
    .rab-category th:nth-child(4),
    .rab-category td:nth-child(4) {
      width: 10%;
    }
    .rab-category th:nth-child(5),
    .rab-category td:nth-child(5) {
      width: 8%;
    }
    .rab-category th:nth-child(6),
    .rab-category td:nth-child(6) {
      width: 15%;
    }
    .rab-category th:nth-child(7),
    .rab-category td:nth-child(7) {
      width: 17%;
    }
    .grand-total-box {
      margin-top: 30px;
      padding: 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      width: 350px;
    }
    .grand-total-box div {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .grand-total-box .label {
      font-weight: bold;
    }
    .error-message {
      background-color: #fee2e2;
      border: 1px solid #ef4444;
      color: #991b1b;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="file" id="fileInput" accept=".xls,.xlsx">
      <button type="submit">Upload & Preview</button>
    </form>

    <div id="errorContainer"></div>
    <div id="rabTables"></div>

    <!-- final total box -->
    <div class="grand-total-box" id="grandTotalBox" style="display:none;">
      <div><span class="label">Total</span> <span id="grandTotal">Rp. 0</span></div>
      <div><span class="label">PPN (10%)</span> <span id="ppn">Rp. 0</span></div>
      <div><span class="label">Total (Termasuk PPN)</span> <span id="totalWithPpn">Rp. 0</span></div>
      <div><span class="label">Terbilang</span> <span id="terbilang">NOL RUPIAH</span></div>
    </div>

    <a href="#" class="action-btn">+ Tambah Kategori Pekerjaan/Pilih Referensi RAB</a>
  </div>

  <script>
    function showError(message) {
      const errorContainer = document.getElementById("errorContainer");
      errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      setTimeout(() => {
        errorContainer.innerHTML = "";
      }, 5000);
    }

    document.getElementById("uploadForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      if (!fileInput.files.length) {
        showError("Silakan pilih file Excel terlebih dahulu");
        return;
      }
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      try {
        const resp = await fetch("/excel_parser/preview_rows", {
          method: "POST",
          body: formData
        });
        const data = await resp.json();
        console.log("Response data:", data);

        if (data.rows) {
          renderTables(data.rows);
        } else {
          showError("Gagal memproses file: " + (data.error || "Terjadi kesalahan yang tidak diketahui"));
        }
      } catch (err) {
        showError("Terjadi kesalahan saat mengunggah file: " + err.message);
      }
    });

    function renderTables(rows) {
      const container = document.getElementById("rabTables");
      container.innerHTML = "";
      let total = 0;
      let currentTable = null;
      let tbody = null;
      let bujakCounter = 0;

      rows.forEach(row => {
        // Skip calculation rows that should not appear in the table
        const skipKeywords = ["PAJAK", "JUMLAH SETELAH PAJAK", "DIBULATKAN", "TERBILANG"];
        if (row.description && skipKeywords.some(k => row.description.toUpperCase().includes(k))) {
          return;
        }

        // Detect new BUJAK section
        if (row.is_section && row.section_type === "CATEGORY" && row.number === "A") {
          bujakCounter++;
          const header = document.createElement("div");
          header.classList.add("bujak-header");
          header.innerText = `BUJAK ${bujakCounter}`;
          container.appendChild(header);
          
          // Create a new table for this BUJAK
          const table = document.createElement("table");
          table.classList.add("rab-category");
          table.innerHTML = `
            <thead>
              <tr>
                <th>No.</th>
                <th>Uraian Pekerjaan</th>
                <th>Kode</th>
                <th>Volume</th>
                <th>SAT</th>
                <th>Harga Sat (Rp.)</th>
                <th>Jumlah (Rp.)</th>
              </tr>
            </thead>
            <tbody></tbody>
          `;
          container.appendChild(table);
          currentTable = table;
          tbody = table.querySelector("tbody");
        }

        if (row.is_section && row.section_type === "CATEGORY") {
          if (!currentTable) return;
          tbody = currentTable.querySelector("tbody");
          const tr = document.createElement("tr");
          tr.dataset.role = "category";
          tr.innerHTML = `
            <td>${row.number}</td>
            <td colspan="6"><strong>${row.description}</strong></td>
          `;
          tbody.appendChild(tr);
        }

        else if (row.is_section && row.section_type === "SECTION") {
          if (!currentTable) return;
          tbody = currentTable.querySelector("tbody");
          const tr = document.createElement("tr");
          tr.dataset.role = "section";
          tr.innerHTML = `
            <td>${row.number}</td>
            <td colspan="6"><strong>${row.description}</strong></td>
          `;
          tbody.appendChild(tr);
        }

        else if (!row.is_section) {
          if (!currentTable) return;
          tbody = currentTable.querySelector("tbody");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td></td>
            <td>${row.description || ""}</td>
            <td>${row.analysis_code || ""}</td>
            <td>${row.volume || ""}</td>
            <td>${row.unit || ""}</td>
            <td>${(row.price || 0).toLocaleString()}</td>
            <td class="jumlah">Rp. ${(row.total_price || 0).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
          total += row.total_price || 0;
        }
      });

      // Update grand total box
      document.getElementById("grandTotalBox").style.display = "block";
      document.getElementById("grandTotal").innerText = "Rp. " + total.toLocaleString();
      const ppn = total * 0.1;
      document.getElementById("ppn").innerText = "Rp. " + ppn.toLocaleString();
      document.getElementById("totalWithPpn").innerText = "Rp. " + (total + ppn).toLocaleString();
      document.getElementById("terbilang").innerText = total === 0 ? "NOL RUPIAH" : numberToWords(total + ppn).toUpperCase();
    }

    // Simple function to convert number into words (basic placeholder)
    function numberToWords(number) {
      return number.toLocaleString("id-ID") + " rupiah";
    }
  </script>
</body>
</html>