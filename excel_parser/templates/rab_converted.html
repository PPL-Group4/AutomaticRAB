{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="section-box position-relative">
  <h5 class="section-title">RAB Preview (Excel)</h5>

  <!-- Upload form -->
  <form id="uploadForm" enctype="multipart/form-data" class="mb-3">
    <div class="input-group">
      <input type="file" name="file" id="fileInput" accept=".xls,.xlsx" class="form-control">
      <button type="submit" class="btn btn-primary" style="background-color:#00365a;">Upload & Preview</button>
    </div>
  </form>

  <!-- Error messages -->
  <div id="errorContainer"></div>

  <!-- Spinner -->
  <div id="loadingSpinner" class="text-center py-4" style="display:none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Memproses file, mohon tunggu...</p>
  </div>

  <!-- Tables will render here -->
  <div id="rabTables" class="mt-3"></div>

  <!-- Grand total -->
  <div class="grand-total-box card mt-4 p-3 shadow-sm" id="grandTotalBox" style="display:none; max-width:400px;">
    <div class="d-flex justify-content-between"><span class="fw-bold">Total</span> <span id="grandTotal">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">PPN (10%)</span> <span id="ppn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Total (Termasuk PPN)</span> <span id="totalWithPpn">Rp. 0</span></div>
    <div class="d-flex justify-content-between"><span class="fw-bold">Terbilang</span> <span id="terbilang">NOL RUPIAH</span></div>
  </div>

  <a href="#" class="btn btn-outline-primary mt-3">+ Tambah Kategori Pekerjaan / Pilih Referensi RAB</a>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  {{ block.super }}

  const MATCH_ENDPOINT = "{% url 'match-best' %}";
  const suggestionCache = new Map();
  const dropdownRequestState = new WeakMap();
  const MANUAL_SUGGESTION_LIMIT = 12;

  function showError(message) {
    const errorContainer = document.getElementById("errorContainer");
    errorContainer.innerHTML = `<div class="alert alert-danger">${message}</div>`;
    setTimeout(() => {
      errorContainer.innerHTML = "";
    }, 5000);
  }

  function showLoading() {
    document.getElementById("loadingSpinner").style.display = "block";
  }

  function hideLoading() {
    document.getElementById("loadingSpinner").style.display = "none";
  }

  document.getElementById("uploadForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const fileInput = document.getElementById("fileInput");
    if (!fileInput.files.length) {
      showError("Silakan pilih file Excel terlebih dahulu");
      return;
    }
    const formData = new FormData();
    formData.append("file", fileInput.files[0]);

    try {
      showLoading(); // spinner ON
      const resp = await fetch("/excel_parser/preview_rows", {
        method: "POST",
        body: formData
      });
      const data = await resp.json();
      hideLoading(); // spinner OFF

      if (data.rows) {
        renderTables(data.rows);
      } else {
        showError("Gagal memproses file: " + (data.error || "Terjadi kesalahan yang tidak diketahui"));
      }
    } catch (err) {
      hideLoading();
      showError("Terjadi kesalahan saat mengunggah file: " + err.message);
    }
  });

  function renderTables(rows) {
    const container = document.getElementById("rabTables");
    container.innerHTML = "";
    let total = 0;
    let currentTable = null;
    let tbody = null;
    let bujakCounter = 0;

    rows.forEach((row, rowIndex) => {
      const skipKeywords = ["PAJAK", "JUMLAH SETELAH PAJAK", "DIBULATKAN", "TERBILANG"];
      if (row.description && skipKeywords.some(k => row.description.toUpperCase().includes(k))) {
        return;
      }

      if (row.is_section && row.section_type === "CATEGORY" && row.number === "A") {
        bujakCounter++;
        const header = document.createElement("div");
        header.classList.add("alert", "alert-warning", "fw-bold", "mt-3");
        header.innerText = `BUJAK ${bujakCounter}`;
        container.appendChild(header);

        const table = document.createElement("table");
        table.classList.add("table", "table-bordered", "table-sm", "align-middle", "mb-4");

        table.innerHTML = `
          <thead class="table-light">
            <tr>
              <th>No.</th>
              <th>Uraian Pekerjaan</th>
              <th>Kode</th>
              <th>Status Pencocokan</th>
              <th>Hasil AHSP</th>
              <th>Volume</th>
              <th>SAT</th>
              <th>Harga Sat (Rp.)</th>
              <th>Jumlah (Rp.)</th>
            </tr>
          </thead>
        `;
        const newBody = document.createElement("tbody");
        table.appendChild(newBody);
        container.appendChild(table);
        currentTable = table;
        tbody = newBody;
      }

      if (!currentTable || !tbody) {
        return;
      }

      if (row.is_section && row.section_type === "CATEGORY") {
        const tr = document.createElement("tr");
        const numberCell = document.createElement("td");
        numberCell.textContent = row.number || "";
        tr.appendChild(numberCell);

        const titleCell = document.createElement("td");
        titleCell.colSpan = 8;
        const strong = document.createElement("strong");
        strong.textContent = row.description || "";
        titleCell.appendChild(strong);
        tr.appendChild(titleCell);
        tbody.appendChild(tr);
        return;
      }

      if (row.is_section && row.section_type === "SECTION") {
        const tr = document.createElement("tr");
        const numberCell = document.createElement("td");
        numberCell.textContent = row.number || "";
        tr.appendChild(numberCell);

        const titleCell = document.createElement("td");
        titleCell.colSpan = 8;
        const emphasis = document.createElement("em");
        emphasis.textContent = row.description || "";
        titleCell.appendChild(emphasis);
        tr.appendChild(titleCell);
        tbody.appendChild(tr);
        return;
      }

      if (row.is_section) {
        return;
      }

      const tr = document.createElement("tr");

      const numberCell = document.createElement("td");
      numberCell.textContent = "";
      tr.appendChild(numberCell);

      const descriptionCell = document.createElement("td");
      descriptionCell.textContent = row.description || "";
      tr.appendChild(descriptionCell);

      const analysisCell = document.createElement("td");
      analysisCell.classList.add("analysis-code-cell");
      analysisCell.textContent = row.analysis_code || "";
      tr.appendChild(analysisCell);

      const statusCell = document.createElement("td");
      statusCell.textContent = formatMatchStatusText(row);
      tr.appendChild(statusCell);

      const matchCell = document.createElement("td");
      populateMatchCell(matchCell, row, analysisCell, statusCell);
      tr.appendChild(matchCell);

      const volumeCell = document.createElement("td");
      volumeCell.textContent = row.volume || "";
      tr.appendChild(volumeCell);

      const unitCell = document.createElement("td");
      unitCell.textContent = row.unit || "";
      tr.appendChild(unitCell);

      const priceCell = document.createElement("td");
      priceCell.textContent = formatCurrencyValue(row.price);
      tr.appendChild(priceCell);

      const totalCell = document.createElement("td");
      totalCell.textContent = "Rp. " + formatCurrencyValue(row.total_price);
      tr.appendChild(totalCell);

      tbody.appendChild(tr);

      total += parseCurrencyNumber(row.total_price);
    });

    document.getElementById("grandTotalBox").style.display = "block";
    document.getElementById("grandTotal").innerText = "Rp. " + total.toLocaleString();
    const ppn = total * 0.1;
    document.getElementById("ppn").innerText = "Rp. " + ppn.toLocaleString();
    document.getElementById("totalWithPpn").innerText = "Rp. " + (total + ppn).toLocaleString();
    document.getElementById("terbilang").innerText = total === 0 ? "NOL RUPIAH" : numberToWords(total + ppn).toUpperCase();
  }

  function numberToWords(number) {
    return number.toLocaleString("id-ID") + " rupiah";
  }

  function formatMatchStatusText(row) {
    if (row.job_match_selected) {
      if (row.job_match_selected.match_status === "Manual" || row.job_match_status === "manual") {
        return "Manual";
      }
      return "Dipilih";
    }

    const status = row.job_match_status;
    if (!status || status === "skipped") {
      return "Skipped";
    }
    if (status === "error") {
      return "Error";
    }

    const matches = normalizeMatches(row.job_match);
    const fallback = matches.find(entry => entry && entry.match_status && !entry.code);
    if (fallback) {
      return fallback.match_status;
    }

    return status.replace(/(^|\s)\w/g, letter => letter.toUpperCase());
  }

  function populateMatchCell(cell, row, analysisCell, statusCell) {
    if (row.job_match_status === "error") {
      cell.textContent = row.job_match_error ? `Error: ${row.job_match_error}` : "Error";
      return;
    }

    const matches = normalizeMatches(row.job_match);
    const lookup = updateRowLookup(row, matches);
    const selectableMatches = matches.filter(match => match && match.code);
    const fallbackMessages = matches.filter(match => !match || !match.code);

    if (!selectableMatches.length && !fallbackMessages.length) {
      // No suggestions from matching service — allow manual input so user can type AHSP kode
      renderManualInput(cell, row, analysisCell, statusCell, "Needs Manual Input");
      return;
    }

    if (selectableMatches.length) {
      if (selectableMatches.length > 1) {
        const helper = document.createElement("div");
        helper.className = "text-muted small mb-1";
        helper.textContent = "Pilih salah satu untuk mengisi kolom Kode.";
        cell.appendChild(helper);
      }

      selectableMatches.forEach(match => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "btn btn-sm btn-outline-primary w-100 text-start match-option mb-1";
        const label = buildMatchLabel(match);
        button.dataset.label = label;
        button.textContent = label;
        button.addEventListener("click", () => {
          handleMatchSelection(match, row, analysisCell, statusCell, cell, button);
        });
        cell.appendChild(button);
      });
    }

    if (fallbackMessages.length) {
      const message = fallbackMessages[0] && fallbackMessages[0].match_status
        ? fallbackMessages[0].match_status
        : "Needs Manual Input";
      renderManualInput(cell, row, analysisCell, statusCell, message);
    }
  }

  function normalizeMatches(matchData) {
    if (!matchData) {
      return [];
    }
    return Array.isArray(matchData) ? matchData : [matchData];
  }

  function buildMatchLabel(match) {
    const pieces = [];
    if (match.code) {
      pieces.push(match.code);
    }
    if (match.name) {
      pieces.push(match.name);
    }
    if (typeof match.confidence === "number") {
      const pct = Math.round(match.confidence * 100);
      pieces.push(`${pct}%`);
    }
    return pieces.length ? pieces.join(" — ") : "Pilih";
  }

  function handleMatchSelection(match, row, analysisCell, statusCell, matchCell, button) {
    row.job_match_selected = match;
    row.analysis_code = match.code || "";
    updateRowLookup(row, [match]);

    analysisCell.textContent = row.analysis_code;
    statusCell.textContent = "Dipilih";
    statusCell.classList.add("text-success");

    matchCell.querySelectorAll("button.match-option").forEach(btn => {
      btn.classList.remove("btn-success");
      btn.classList.add("btn-outline-primary");
      if (btn.dataset.label) {
        btn.textContent = btn.dataset.label;
      }
    });

    button.classList.remove("btn-outline-primary");
    button.classList.add("btn-success");
    button.textContent = `Dipilih: ${button.dataset.label}`;
  }

  function renderManualInput(cell, row, analysisCell, statusCell, label) {
    cell.style.position = "relative";
    const notice = document.createElement("div");
    notice.className = "text-warning small mb-2";
    notice.textContent = label || "Needs Manual Input";
    cell.appendChild(notice);

    const group = document.createElement("div");
    group.className = "input-group input-group-sm manual-match-group";

    const input = document.createElement("input");
    input.type = "text";
    input.className = "form-control";
    input.placeholder = "Masukkan kode AHSP";
    input.value = row.analysis_code || "";
    input.autocomplete = "off";

    const dropdown = document.createElement("div");
    dropdown.className = "dropdown-menu w-100";
    dropdown.style.maxHeight = "200px";
    dropdown.style.overflowY = "auto";
    dropdown.style.display = "none";
    dropdown.style.left = "0";
    dropdown.style.top = "100%";
    dropdown.style.zIndex = "1000";

    const updateNotice = (message) => {
      notice.textContent = message || label || "Needs Manual Input";
    };

    const button = document.createElement("button");
    button.type = "button";
    button.className = "btn btn-primary";
    button.textContent = "Gunakan";

    const applyManual = () => {
      const value = input.value.trim();
      if (!value) {
        input.focus();
        return;
      }

      const matched = findMatchByCode(row, value);
      row.analysis_code = value;
      row.job_match_selected = matched ? { ...matched, match_status: "Manual" } : {
        code: value,
        match_status: "Manual",
      };
      row.job_match_status = "manual";
      updateRowLookup(row, matched ? [matched] : []);

      if (matched && matched.name) {
        updateNotice(`Manual: ${matched.name}`);
      } else {
        updateNotice(label);
      }

      analysisCell.textContent = value;
      statusCell.textContent = "Manual";
      statusCell.classList.add("text-success");

      cell.querySelectorAll("button.match-option").forEach(btn => {
        btn.classList.remove("btn-success");
        btn.classList.add("btn-outline-primary");
        if (btn.dataset.label) {
          btn.textContent = btn.dataset.label;
        }
      });

      button.classList.remove("btn-primary");
      button.classList.add("btn-success");
      button.textContent = "Dipakai";
      dropdown.style.display = "none";
    };

    button.addEventListener("click", applyManual);
    input.addEventListener("keydown", event => {
      if (event.key === "Enter") {
        event.preventDefault();
        applyManual();
      }
    });

    let dropdownDebounce;
    const triggerDropdown = () => showDropdown(input, dropdown, row, label);
    input.addEventListener("focus", triggerDropdown);
    input.addEventListener("input", () => {
      clearTimeout(dropdownDebounce);
      dropdownDebounce = setTimeout(triggerDropdown, 200);
    });
    input.addEventListener("blur", () => {
      setTimeout(() => {
        dropdown.style.display = "none";
      }, 150);
    });

    dropdown.addEventListener("mousedown", event => {
      event.preventDefault();
    });

    group.appendChild(input);
    group.appendChild(button);
    cell.appendChild(group);
    cell.appendChild(dropdown);
  }

  function showDropdown(input, dropdown, row, label) {
    const query = input.value.trim();
    const lookupMatches = filterMatches(Array.from(getMatchLookup(row).values()), query);

    if (lookupMatches.length) {
      renderDropdownOptions(dropdown, lookupMatches, input);
    } else {
      renderDropdownOptions(dropdown, [], input, { placeholderText: label || "Mencari saran..." });
    }

    const requestToken = Symbol("suggestion-request");
    dropdownRequestState.set(dropdown, requestToken);

    fetchAndStoreSuggestions(row, query).then(allMatches => {
      if (dropdownRequestState.get(dropdown) !== requestToken) {
        return;
      }

      const combined = filterMatches(dedupeMatches(allMatches), query);
      if (combined.length) {
        renderDropdownOptions(dropdown, combined, input);
      } else {
        renderDropdownOptions(dropdown, [], input, { placeholderText: "Tidak ada saran" });
      }
    });
  }

  function getMatchLookup(row) {
    if (!row._matchLookup || !(row._matchLookup instanceof Map)) {
      row._matchLookup = new Map();
    }
    return row._matchLookup;
  }

  function updateRowLookup(row, matches) {
    const lookup = getMatchLookup(row);
    const list = Array.isArray(matches) ? matches : [matches];
    list.forEach(match => {
      if (match && match.code) {
        lookup.set(match.code.toLowerCase(), match);
      }
    });
    return lookup;
  }

  function filterMatches(matches, query) {
    const lowered = (query || "").trim().toLowerCase();
    if (!lowered) {
      return matches;
    }
    return matches.filter(match => {
      if (!match || !match.code) {
        return false;
      }
      const code = match.code.toLowerCase();
      const name = (match.name || "").toLowerCase();
      return code.includes(lowered) || name.includes(lowered);
    });
  }

  function renderDropdownOptions(dropdown, matches, input, options = {}) {
    const { placeholderText } = options;
    dropdown.innerHTML = "";

    if (!matches.length) {
      if (placeholderText) {
        const info = document.createElement("div");
        info.className = "dropdown-item-text text-muted";
        info.textContent = placeholderText;
        dropdown.appendChild(info);
        const width = input.getBoundingClientRect().width;
        dropdown.style.minWidth = `${width}px`;
        dropdown.style.display = "block";
        dropdown.classList.add("show");
      } else {
        dropdown.style.display = "none";
        dropdown.classList.remove("show");
      }
      return;
    }

    const width = input.getBoundingClientRect().width;
    dropdown.style.minWidth = `${width}px`;

    matches.slice(0, MANUAL_SUGGESTION_LIMIT).forEach(match => {
      if (!match || !match.code) {
        return;
      }
      const item = document.createElement("button");
      item.type = "button";
      item.className = "dropdown-item text-wrap";
      item.textContent = `${match.code} — ${match.name || ""}`;
      item.addEventListener("click", () => {
        input.value = match.code;
        dropdown.style.display = "none";
        input.focus();
      });
      dropdown.appendChild(item);
    });

  const shouldShow = dropdown.childElementCount > 0;
  dropdown.style.display = shouldShow ? "block" : "none";
  dropdown.classList.toggle("show", shouldShow);
  }

  function dedupeMatches(matches) {
    const map = new Map();
    matches.forEach(match => {
      if (!match || !match.code) {
        return;
      }
      const key = match.code.toLowerCase();
      if (!map.has(key)) {
        map.set(key, match);
      }
    });
    return Array.from(map.values());
  }

  function fetchRemoteSuggestions(row, query, limit = MANUAL_SUGGESTION_LIMIT) {
    const trimmedQuery = (query || "").trim();
    const description = trimmedQuery || (row.description || "").trim();

    if (!description) {
      return Promise.resolve([]);
    }

    const cacheKey = `${description}|${limit}`;
    if (suggestionCache.has(cacheKey)) {
      return suggestionCache.get(cacheKey);
    }

    const request = fetch(MATCH_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
      },
      body: JSON.stringify({ description }),
    })
      .then(res => (res.ok ? res.json() : { match: [] }))
      .then(data => {
        const { match } = data || {};
        if (!match) {
          return [];
        }
        if (Array.isArray(match)) {
          return match;
        }
        return match.code ? [match] : [];
      })
      .catch(() => []);

    suggestionCache.set(cacheKey, request);
    return request;
  }

  function fetchAndStoreSuggestions(row, query) {
    return fetchRemoteSuggestions(row, query).then(results => {
      updateRowLookup(row, results);
      return Array.from(getMatchLookup(row).values());
    });
  }

  function findMatchByCode(row, code) {
    const lookup = getMatchLookup(row);
    if (!code) {
      return null;
    }
    return lookup.get(code.toLowerCase()) || null;
  }

  function parseCurrencyNumber(value) {
    if (typeof value === "number") {
      return Number.isFinite(value) ? value : 0;
    }
    if (value === null || value === undefined) {
      return 0;
    }
    const numeric = parseFloat(String(value).replace(/[^0-9.-]/g, ""));
    return Number.isFinite(numeric) ? numeric : 0;
  }

  function formatCurrencyValue(value) {
    return parseCurrencyNumber(value).toLocaleString("id-ID", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  }
</script>
{% endblock %}
